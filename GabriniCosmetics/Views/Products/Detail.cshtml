@model GabriniCosmetics.Models.ViewModel.ProductVM
@{
    string culture = System.Threading.Thread.CurrentThread.CurrentUICulture.Name;
    var productName = culture.StartsWith("en") ? Model.Products.Product.NameEn : Model.Products.Product.NameAr;
    var productDesc = culture.StartsWith("en") ? Model.Products.Product.DescriptionEn : Model.Products.Product.DescriptionAr;
    var categoryName = culture.StartsWith("en") ? Model.Products.Product.Subcategory.Category.NameEn : Model.Products.Product.Subcategory.Category.NameAr;
    var subCategoryName = culture.StartsWith("en") ? Model.Products.Product.Subcategory.NameEn : Model.Products.Product.Subcategory.NameAr;
}
<div class="master-wrapper-page">
    <div class="breadcrumb">
        <div class="container">
            <div class="page-title">
                <h1>@productName</h1>
            </div>
            <ul>
                <li><span> <a href="/"> <span>@Localizer["Home"]</span> </a> </span> <span class="delimiter">/</span></li>
                <li>
                    <a asp-controller="Categories" asp-action="index" asp-route-id="@Model.Products.Product.Subcategory.CategoryId"> <span itemprop="name">@categoryName</span> </a> <span class="delimiter">/</span>
                </li>
                <li>
                    <span itemprop="name">@subCategoryName</span> <span class="delimiter">/</span>
                </li>
                <li>
                    <strong class="current-item">@productName</strong> 
                </li>
            </ul>
        </div>
    </div>
    <div class="master-wrapper-content" style="margin-top:16px;">
        <div class="master-column-wrapper">
            <div class="center-1">
                <div class="page product-details-page">
                    <div class="page-body">
                        <form method="post" id="product-details-form" novalidate="novalidate">
                            <div data-productid="107">
                                <div class="product-essential">
                                    <div class="gallery">
                                        <div>
                                            <div class="offer-content product-ribbon"></div>
                                            <div id="wrap">
                                                <a href="~/uploads/@Model.Products.Images.FirstOrDefault().ImagePath" class="cloud-zoom">
                                                    <img alt="@Localizer["PictureOf"] @productName" src="~/uploads/@Model.Products.Images.FirstOrDefault().ImagePath" title="@Localizer["PictureOf"] @productName" class="cloud-zoom-image cloud-zoom-image-size" width="400" id="dbrandImage">
                                                </a>
                                            </div>
                                            <div class="cloud-zoom-thumb-container">
                                                @foreach (var item in Model.Products.Images)
                                                {
                                                    <div class="cloud-zoom-thumb" onclick="changeMainImage('../../uploads/@item.ImagePath')">
                                                        <a href="javascript:void(0);" class="src-zoom-anchor">
                                                            <img src="~/uploads/@item.ImagePath" alt="@Localizer["PictureOf"] @productName" title="@Localizer["PictureOf"] @productName" class="src-zoom-image">
                                                        </a>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="overview">
                                        <div class="product-overview-content">
                                            <div class="additional-details">
                                                <div class="sku"><span class="value">@Localizer["Category"]:</span> <span class="label" id="sku-107">@categoryName</span></div>
                                                <div class="sku"><span class="value">@Localizer["SubCategory"]:</span> <span class="label" id="sku-107">@subCategoryName</span></div>
                                                <div class="sku"><span class="value">@Localizer["Product"]:</span> <span class="label" id="sku-107">@productName</span></div>
                                            </div>
                                            <div class="short-description">@productDesc</div>
                                            <div class="attributes">
                                                <dl>
                                                    <dt id="product_attribute_label"><label class="text-prompt">@Localizer["Colors"]</label></dt>
                                                    <dd id="product_attribute_input">
                                                        <ul class="option-list attribute-squares color-squares">
                                                            @foreach (var item in Model.Products.Colors)
                                                            {
                                                                <li>
                                                                    <label for="product_attribute_@item.Id" style="display: flex; align-items: center;">
                                                                        <input id="product_attribute_${@item.Id}" type="radio" name="product_color" value="${@item.Id}" data-color-name="${@item.ColorName}" style="margin-right: 10px; display:block">
                                                                        <span class="attribute-square-container">
                                                                            <span class="attribute-square" style="background-color:@item.ColorName">&nbsp;</span>
                                                                        </span>
                                                                    </label>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                        <div class="product-overview-pricing-cart">
                                            <div class="availability">
                                                <div class="stock"><span class="label">@Localizer["Availability"]:</span> 
                                                    @if (Model.Products.Product.IsAvailability)
                                                    {
                                                        <span class="value in-stock" id="stock-availability">@Localizer["InStock"]</span>
                                                    }
                                                    else
                                                    {
                                                    <span class="value in-stock" id="stock-availability">@Localizer["OutSold"]</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="prices">
                                                <div class="product-price">
                                                    @if (Model.Products.Product.Flags.Any(f => f.FlagType == "Sale"))
                                                    {
                                                        <span class="price old-price-detail">@Model.Products.Product.Price @Localizer["JOD"]</span>
                                                        <span class="price actual-price">@Model.Products.Product.PriceAfterDiscount @Localizer["JOD"]</span>
                                                    }else{
                                                        <span class="price actual-price">@Model.Products.Product.Price @Localizer["JOD"]</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="add-to-cart">
                                                <div class="add-to-cart-panel">
                                                    <button type="button" id="add-to-cart" class="button-1 AddToCartAccourdingQty" data-product-Id="@Model.Products.Product.Id"> @Localizer["AddToCart"]</button> 
                                                    <label class="qty-label" for="addtocart_107_EnteredQuantity">Qty:</label>
                                                    <div class="qty-input-wrap">
                                                        <button type="button" class="qty-btn qty-minus" value="-1">-</button> 
                                                        <input id="EnteredQuantity" class="qty-input" type="text" aria-label="Enter a quantity" data-val="true" value="1"> 
                                                        <button type="button" class="qty-btn qty-plus" value="1">+</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="overview-buttons">
                                                <div class="add-to-wishlist">
                                                    <button type="button" class="button-2 AddToWishlistWithQtyAngImg" data-product-Id="@Model.Products.Product.Id" >@Localizer["AddtoWishlist"]</button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="related-carousel">
                                    <div class="swiper swiper-initialized swiper-horizontal swiper-backface-hidden">
                                        <div class="title">
                                            <strong>Customers who bought this item also bought</strong>
                                            <div class="swiper-nav">
                                                <div class="icon-right-arrow-2" tabindex="0" role="button" aria-label="Next slide" aria-controls="swiper-wrapper" aria-disabled="false"></div>
                                                <div class="icon-left-arrow-2 swiper-button-disabled" tabindex="-1" role="button" aria-label="Previous slide" aria-controls="swiper-wrapper" aria-disabled="true"></div>
                                            </div>
                                        </div>
                                        <div class="swiper-wrapper" id="swiper-wrapper" aria-live="polite">
                                            @foreach(var item in Model.ProductBySubCategory)
                                            {
                                               var name = culture.StartsWith("en") ? item.Product.NameEn : item.Product.NameAr;
                                                <div class="item-box swiper-slide">
                                                    <div class="product-item" data-productid="@item.Product.Id" data-quick-view="true">
                                                        <div class="picture">
                                                            <div class="offer-content product-ribbon"></div>
                                                            <div class="swiper swiper-initialized swiper-horizontal swiper-backface-hidden" id="swiper-@item.Product.Id" style="overflow: unset;">
                                                                <div class="swiper-wrapper" id="swiper-wrapper">
                                                                    @foreach (var img in item.Product.Images)
                                                                    {
                                                                        <a class="swiper-slide padding-b swiper-slide-prev" asp-controller="Products" asp-action="Detail" asp-route-id="@img.Product.Id" title="@Localizer["ShowDetailsFor"] @name" style="width: 199px;">
                                                                            <img alt="@Localizer["PictureOf"] @name" src="~/uploads/@img.ImagePath" title="@Localizer["ShowDetailsFor"] @name">
                                                                        </a>
                                                                    }
                                                                </div>
                                                                <div class="swiper-pagination swiper-pagination-clickable swiper-pagination-bullets swiper-pagination-horizontal">
                                                                    <span class="swiper-pagination-bullet" tabindex="0" role="button" aria-label="Go to slide 1"></span>
                                                                    <span class="swiper-pagination-bullet swiper-pagination-bullet-active" tabindex="0" role="button" aria-label="Go to slide 2" aria-current="true"></span>
                                                                </div>
                                                                <script>
                                                                    document.addEventListener('DOMContentLoaded', function () {
                                                                        var mySwiper = new Swiper('#swiper-@item.Product.Id', {
                                                                            pagination: {
                                                                                clickable: true,
                                                                                el: '.swiper-pagination',
                                                                            },
                                                                        });
                                                                    });
                                                                </script>
                                                            </div>
                                                            <div class="buttons">
                                                                <button type="button" class="button-2 add-to-wishlist-button" data-product-Id="@item.Product.Id" title="@Localizer["AddToWishlist"]">@Localizer["AddToWishlist"]</button>
                                                                <button type="button" class="button-2 quick-view-btn" data-product-Id="@item.Product.Id" title="@Localizer["QuickView"]">
                                                                    <i class="fa-sharp fa-light fa-magnifying-glass-plus"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="details">
                                                            <h2 class="product-title">
                                                                <a asp-controller="Products" asp-action="Detail" asp-route-id="@item.Product.Id">@name</a>
                                                            </h2>
                                                            <div class="add-info">
                                                                <div class="prices">
                                                                    @if (item.Product.Flags.Any(f => f.FlagType == "Sale"))
                                                                    {
                                                                        <span class="price old-price">@item.Product.Price @Localizer["JOD"]</span>
                                                                        <span class="price actual-price">@item.Product.PriceAfterDiscount @Localizer["JOD"]</span>
                                                                    }else{
                                                                        <span class="price actual-price">@item.Product.Price @Localizer["JOD"]</span>
                                                                    }
                                                                </div>
                                                                <div class="add-to-cart">
                                                                    <button type="button" class="button-1 add-to-cart-button" data-product-Id="@item.Product.Id">@Localizer["AddToCart"]</button>
                                                                    <div class="qty-input-wrap">
                                                                        <button type="button" class="qty-btn qty-minus" value="-1">-</button>
                                                                        <input id="product-quantity" class="qty-input" type="text" aria-label="Enter a quantity" value="1">
                                                                        <button type="button" class="qty-btn qty-plus" value="1">+</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            
                                        </div>
                                        <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- Product Detail Quick View Modal -->
<div id="product-detail" class="mfp-wrap mfp-close-btn-in mfp-auto-cursor quickview-popup mfp-ready" tabindex="-1" style="overflow: hidden auto; display: none;">
    <div class="mfp-container mfp-s-ready mfp-inline-holder">
        <div class="mfp-content">
            <div class="qv-modal" id="qv-modal" style="display: block;">
                <div class="qv-details">
                    <div class="page product-details-page">
                        <div class="page-body">
                            <div class="product-name">
                                <h2 id="product-name" itemprop="name"></h2>
                            </div>
                            <form method="post" id="product-details-form" action="">
                                <div data-productid="">
                                    <div class="product-essential">
                                        <!-- Product pictures -->
                                        <div class="gallery" id="product-gallery">
                                            <!-- Dynamic content will be inserted here -->
                                        </div>
                                        <div class="overview">
                                            <div class="product-overview-content">
                                                <!-- SKU -->
                                                <div class="additional-details">
                                                    <div class="sku">
                                                        <span class="value">@Localizer["Category"]:</span>
                                                        <span class="label" id="product-Category"></span>
                                                    </div>
                                                    <div class="sku">
                                                        <span class="value">@Localizer["SubCategory"]:</span>
                                                        <span class="label" id="product-subCategory"></span>
                                                    </div>
                                                    <div class="sku">
                                                        <span class="value">@Localizer["Product"]:</span>
                                                        <span class="label" id="products"></span>
                                                    </div>
                                                </div>
                                                <!-- Attributes -->
                                                <div class="attributes" id="product-attributes">
                                                    <!-- Dynamic content will be inserted here -->
                                                </div>
                                            </div>
                                            <div class="product-overview-pricing-cart">
                                                <!-- Price & add to cart -->
                                                <div class="prices">
                                                    <div class="product-price">
                                                        <span itemprop="price" id="product-price" class="price-value"></span>
                                                    </div>
                                                </div>
                                                <div class="add-to-cart">
                                                    <div class="add-to-cart-panel">
                                                        <button type="button" id="add-to-cart-button" data-product-id="" class="button-1 add-to-cart-button">
                                                            <i class="icon-cart mr-2"></i> @Localizer["AddToCart"]
                                                        </button>
                                                        <div class="qty-input-wrap">
                                                            <button type="button" class="qty-btn qty-minus" value="-1">-</button>
                                                            <input id="product-quantity" class="qty-input" type="text" aria-label="Enter a quantity" value="1">
                                                            <button type="button" class="qty-btn qty-plus" value="1">+</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Wishlist -->
                                                <div class="overview-buttons">
                                                    <div class="add-to-wishlist">
                                                        <button type="button" id="add-to-wishlist-button" data-product-id="" class="button-2 AddToWishlistWithQtyAngImg">
                                                            <i class="icon-heart mr-2"></i> @Localizer["AddToWishlist"]
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <button title="Close (Esc)" type="button" class="mfp-close">×</button>
            </div>
        </div>
    </div>
</div>

<div id="bar-notification-error" class="bar-notification-container" data-close="Close">
    <div class="bar-notification error" style="display: none;">
        <p class="content">@Localizer["PleaseSelectColor"]</p>
        <span class="close" title="Close"></span>
    </div>
</div>
<div id="bar-notification-wishlist" class="bar-notification-container" data-close="Close">
    <div class="bar-notification success" style="display: none;">
        <p class="content">@Localizer["AlertAdded"] <a href="/Wishlist">@Localizer["wishlist"]</a></p>
        <span class="close" title="Close"></span>
    </div>
</div>
<div id="bar-notification-cart" class="bar-notification-container" data-close="Close">
    <div class="bar-notification success" style="display: none;">
        <p class="content">@Localizer["AlertAdded"] <a href="/cart">@Localizer["cart"]</a></p>
        <span class="close" title="Close"></span>
    </div>
</div>
<script>
    // Function to change the main image
    function changeMainImage(newSrc, isQuickView = false) {
        if (isQuickView) {
            // Update the image inside the quick view modal
            $('#dbrandImageQ').attr('src', newSrc);
        } else {
            // Update the main image outside the quick view
            $('#dbrandImage').attr('src', newSrc);
        }
    }

    function updateProductDetailModal(product) {
        const culture = "@culture";
        const PName = culture.startsWith("en") ? product.product.nameEn : product.product.nameAr;
        const CName = culture.startsWith("en") ? product.product.subcategory.category.nameEn : product.product.subcategory.category.nameAr;
        const SCName = culture.startsWith("en") ? product.product.subcategory.nameEn : product.product.subcategory.nameAr;
        
        $('#product-name').text(PName);
        $('#product-Category').text(CName);
        $('#product-subCategory').text(SCName);
        $('#products').text(PName);
        $('#product-quantity').val(1);
        
        const localizerJOD = "JOD";
        const gallery = $('#product-gallery').empty();
        
        gallery.append(`
            <div id="wrap" style="top:0px;z-index:9999;position:relative;">
                <img alt="@Localizer["PictureOf"] ${PName}" src="${window.location.origin}/uploads/${product.product.images.$values[0].imagePath}" title="@Localizer["PictureOf"] ${PName}" style="height: auto; width: 100%; border-width: 0px; display: block;" class="cloud-zoom-image cloud-zoom-image-size" width="400" id="dbrandImageQ">
            </div>
        `);
        
        product.product.images.$values.forEach(image => {
            gallery.append(`
                <div class="cloud-zoom-thumb" style="margin-top:16px">
                    <a href="${window.location.origin}/uploads/${image.imagePath}" rel="lightbox-p" class="src-zoom-anchor" onclick="return false;">
                        <img src="${window.location.origin}/uploads/${image.imagePath}" alt="Product Image" class="src-zoom-image">
                    </a>
                </div>
            `);
        });
    
        $(".cloud-zoom-thumb a").on("click", function () {
            const newSrc = $(this).attr('href');
            changeMainImage(newSrc, true); // Pass true for quick view
        });
    
        const attributes = $('#product-attributes').empty();
        
        attributes.append(`
            <dt>
                <label class="text-prompt">@Localizer["Colors"]</label>
                <span class="required">*</span>
            </dt>
            <dd>
                <ul class="option-list attribute-squares color-squares attribute-circle" style="direction:ltr"></ul>
            </dd>
        `);
        
        const ulElement = attributes.find('ul');
        
        product.product.colors.$values.forEach(attribute => {
            const listItem = `
                <li>
                    <label for="product_attribute_${attribute.id}" style="display:flex">
                        <input id="product_attribute_${attribute.id}" type="radio" name="product_color" value="${attribute.id}" data-color-name="${attribute.colorName}" style="margin-right: 10px; display:block">
                        <span class="attribute-square-container">
                            <span class="attribute-square" style="background-color:${attribute.colorName};">&nbsp;</span>
                        </span>
                    </label>
                </li>
            `;
            ulElement.append(listItem);
        });
    
        $('.AddToWishlistWithQtyAngImg').attr('data-product-id', product.product.id);
        $('#add-to-cart-button').attr('data-product-id', product.product.id);
    
        const priceElement = $('#product-price').empty();
    
        if (product.product.flags.$values.some(flag => flag.flagType === 'Sale')) {
            priceElement.append(`
                <div class="prices">
                    <div class="old-product-price">
                        <span>Old price:</span>
                        <span>${product.product.price} ${localizerJOD}</span>
                    </div>
                    <div class="product-price">
                        <label>Price:</label>
                        <span class="price-value">${product.product.priceAfterDiscount} ${localizerJOD}</span>
                    </div>
                </div>
            `);
        } else {
            priceElement.append(`
                <div class="product-price">
                    <label>Price:</label>
                    <span itemprop="price" class="price-value">${product.product.price} ${localizerJOD}</span>
                </div>
            `);
        }
    }

    let hrefValue = "";
    $(".cloud-zoom-thumb").on("click", function () {
        hrefValue = $('#dbrandImage').attr('src');
    });

    $(".AddToCartAccourdingQty").on("click",async function () {
        if(hrefValue== ""){
            hrefValue = @Html.Raw(Json.Serialize(Model.Products.Product.Images.FirstOrDefault().ImagePath))
        }
        var modifiedPath = hrefValue.replace("/images/", "");
        var inputValue = $('#EnteredQuantity').val();
        var productId = $(this).attr('data-product-Id')
    
    
        var selectedColor = $('input[name="product_color"]:checked');
    
        // Ensure selectedColor is not null or undefined
        var colorName = selectedColor.length ? selectedColor.data('color-name').replace('#', '') : '';
    
        if (!colorName) {
            $('#bar-notification-error .bar-notification.error').show();
            return; // Exit the function if colorName is missing
        }
    @if (User.Identity.IsAuthenticated)
    {
        <text>
            try {
                var response = await fetch(`/Cart/AddItemWithQtyAndImage?productId=${productId}&&qty=${inputValue}&&image=${modifiedPath}&color=${colorName}`);
                if (response.status == 200) {
                $('#bar-notification-error .bar-notification.error').hide();
                $('#bar-notification-cart .bar-notification.success').show();
    
                    // Wait for 2 seconds
                    setTimeout(function () {
                        // Reload the page after 2 seconds
                        location.reload();
                    }, 2000);
                }
            }
            catch (err) {
            }
        </text>
    }
    else
    {
    <text>
            window.location.href="/Account/Login"
                </text>
    }});

    // Add to cart button click handler
    $('.add-to-cart-button').on('click', function () {
        var productId = $(this).attr('data-product-Id');
        window.location.href = `/Products/Detail?Id=${productId}`;
    });

    // Add to wishlist button click handler
    $('.add-to-wishlist-button').on('click', function () {
        var productId = $(this).attr('data-product-id');
        window.location.href = `/Products/Detail?Id=${productId}`;
    });

    // Wishlist button with quantity and image click handler
    $(".AddToWishlistWithQtyAngImg").on("click", async function () {
        var productId = $(this).attr('data-product-Id');
        var qty = $('.qty-input').val();
        var img = $('#dbrandImage').attr('src').split('/').pop();
        var selectedColor = $('input[name="product_color"]:checked');

        // Ensure selectedColor is not null or undefined
        var colorName = selectedColor.length ? selectedColor.data('color-name').replace('#', '') : '';

        if (!colorName) {
            $('#bar-notification-error .bar-notification.error').show();
            return; // Exit the function if colorName is missing
        }
    @if (User.Identity.IsAuthenticated)
    {
        <text>
                    try {
                var response = await fetch(`/WishList/AddItemWithQtyAndImage?productId=${productId}&qty=${qty}&image=${img}&color=${colorName}`);
                if (response.status == 200) {
                    // Show the success notification
                    $('#bar-notification-error .bar-notification.error').hide();
                    $('#bar-notification-wishlist .bar-notification.success').show();
                    // Wait for 2 seconds
                    setTimeout(function () {
                        // Reload the page after 2 seconds
                        location.reload();
                    }, 2000);
                }
            } catch (err) {
                console.error('Error:', err);
            }
        </text>
    }
    else
    {
        <text>window.open("/Account/Login", "_self"); </text>
    }
    });

    // Quick View Button
    $(document).on('click', '.quick-view-btn', async function () {
        const productId = $(this).data('product-id');
        try {
            const response = await fetch(`/Products/GetProductById/${productId}`);
            if (response.status == 200) {
                const product = await response.json();
                updateProductDetailModal(product);
                $('#product-detail').show();
            } else {
                console.error('Failed to fetch product details');
            }
        } catch (err) {
            console.error('Error:', err);
        }
    });
    
    $('.mfp-close').on('click', function () {
        $('#product-detail').hide();
    });
</script>