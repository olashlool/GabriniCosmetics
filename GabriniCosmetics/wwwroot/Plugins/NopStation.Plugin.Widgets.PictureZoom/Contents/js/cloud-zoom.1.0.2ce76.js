(function(n){function t(n){for(var t=1;t<arguments.length;t++)n=n.replace("%"+(t-1),arguments[t]);return n}function i(i,r){var u=n("img",i),y,p,e=null,o=null,f=null,h=null,s=null,w=null,c,nt=0,l,a,tt=0,it=0,b=0,k=0,rt=0,d,g,v=this,ut,ft;r.showTitle=!1;setTimeout(function(){if(o===null){var n=i.width();i.parent().append(t('<div style="width:%0px;position:absolute;top:75%;left:%1px;text-align:center" class="cloud-zoom-loading" >Loading...<\/div>',n/3,n/2-n/6)).find(":last").css("opacity",.5)}},200);ft=function(){w!==null&&(w.remove(),w=null)};this.removeBits=function(){f&&(f.remove(),f=null);h&&(h.remove(),h=null);s&&(s.remove(),s=null);ft();n(".cloud-zoom-loading",i.parent()).remove()};this.destroy=function(){i.data("zoom",null);o&&(o.unbind(),o.remove(),o=null);e&&(e.remove(),e=null);this.removeBits()};this.fadedOut=function(){e&&(e.remove(),e=null);this.removeBits()};this.controlLoop=function(){if(f){var n=d-u.offset().left-l*.5>>0,t=g-u.offset().top-a*.5>>0;n<0?n=0:n>u.outerWidth()-l&&(n=u.outerWidth()-l);t<0?t=0:t>u.outerHeight()-a&&(t=u.outerHeight()-a);f.css({left:n,top:t});f.css("background-position",-n+"px "+-t+"px");tt=n/u.outerWidth()*c.width>>0;it=t/u.outerHeight()*c.height>>0;k+=(tt-k)/r.smoothMove;b+=(it-b)/r.smoothMove;e.css("background-position",-(k>>0)+"px "+(-(b>>0)+"px"))}nt=setTimeout(function(){v.controlLoop()},30)};this.init2=function(n,t){rt++;t===1&&(c=n);rt===2&&this.init()};this.init=function(){n(".cloud-zoom-loading",i.parent()).remove();o=i.parent().append(t("<div class='mousetrap' style='background-image:url(\".\");z-index:999;position:absolute;width:%0px;height:%1px;left:%2px;top:%3px;'><\/div>",u.outerWidth(),u.outerHeight(),0,0)).find(":last");o.bind("mousemove",this,function(n){d=n.pageX;g=n.pageY});o.bind("mouseleave",this,function(){return clearTimeout(nt),f&&f.fadeOut(299),h&&h.fadeOut(299),s&&s.fadeOut(299),e.fadeOut(300,function(){v.fadedOut()}),!1});o.bind("mouseenter",this,function(v){var y,it;d=v.pageX;g=v.pageY;ut=v.data;e&&(e.stop(!0,!1),e.remove());var b=r.adjustX,k=r.adjustY,nt=u.outerWidth(),tt=u.outerHeight(),p=r.zoomWidth,w=r.zoomHeight;r.zoomWidth=="auto"&&(p=nt);r.zoomHeight=="auto"&&(w=tt);y=i.parent();switch(r.position){case"top":k-=w;break;case"right":b+=nt;break;case"bottom":k+=tt;break;case"left":b-=p;break;case"inside":p=nt;w=tt;break;default:y=n("#"+r.position);y.length?(p=y.innerWidth(),w=y.innerHeight()):(y=i,b+=nt,k+=tt)}e=y.append(t('<div id="cloud-zoom-big" class="cloud-zoom-big" style="background:white;background-repeat: no-repeat;display:none;position:absolute;left:%0px;top:25px;width:%2px;height:%3px;background-image:url(\'%4\');z-index:99;"><\/div>',b,k,p,w,c.src)).find(":last");u.attr("title")&&r.showTitle&&e.append(t('<div class="cloud-zoom-title">%0<\/div>',u.attr("title"))).find(":last").css("opacity",r.titleOpacity);e.fadeIn(500);f&&(f.remove(),f=null);l=u.outerWidth()/c.width*e.width();a=u.outerHeight()/c.height*e.height();f=i.append(t("<div class = 'cloud-zoom-lens' style='display:none;z-index:98;position:absolute;width:%0px;height:%1px;'><\/div>",l,a)).find(":last");o.css("cursor",f.css("cursor"));it=!1;r.tint&&(f.css("background",'url("'+u.attr("src")+'")'),h=i.append(t('<div style="display:none;position:absolute; left:0px; top:0px; width:%0px; height:%1px; background-color:%2;" />',u.outerWidth(),u.outerHeight(),r.tint)).find(":last"),h.css("opacity",r.tintOpacity),it=!0,h.fadeIn(500));r.softFocus&&(f.css("background",'url("'+u.attr("src")+'")'),s=i.append(t('<div style="position:absolute;display:none;top:2px; left:2px; width:%0px; height:%1px;" />',u.outerWidth()-2,u.outerHeight()-2,r.tint)).find(":last"),s.css("background",'url("'+u.attr("src")+'")'),s.css("opacity",.5),it=!0,s.fadeIn(500));it||f.css("opacity",r.lensOpacity);r.position!=="inside"&&f.fadeIn(500);ut.controlLoop();return})};y=new Image;n(y).load(function(){v.init2(this,0)});y.src=u.attr("src");p=new Image;n(p).load(function(){v.init2(this,1)});p.src=i.attr("href")}n.fn.CloudZoom=function(t){try{document.execCommand("BackgroundImageCache",!1,!0)}catch(r){}return this.each(function(){var u,r;eval("var\ta = {"+n(this).attr("rel")+"}");u=a;n(this).is(".cloud-zoom")?(n(this).css({position:"relative",display:"block"}),n("img",n(this)).css({display:"block"}),n(this).parent().attr("id")!="wrap"&&n(this).wrap('<div id="wrap" style="top:0px;z-index:9999;position:relative;"><\/div>'),r=n.extend({},n.fn.CloudZoom.defaults,t),r=n.extend({},r,u),n(this).data("zoom",new i(n(this),r))):n(this).is(".cloud-zoom-gallery")&&(r=n.extend({},u,t),n(this).data("relOpts",r),n(this).bind("click",n(this),function(t){var i=t.data.data("relOpts");return n("#"+i.useZoom).data("zoom").destroy(),n("#"+i.useZoom).attr("href",t.data.attr("href")),n("#"+i.useZoom+" img").attr("src",t.data.data("relOpts").smallImage),n("#"+t.data.data("relOpts").useZoom).CloudZoom(),!1}))}),this};n.fn.CloudZoom.defaults={zoomWidth:"auto",zoomHeight:"auto",position:"right",tint:!1,tintOpacity:.5,lensOpacity:.5,softFocus:!1,smoothMove:3,showTitle:!0,titleOpacity:.5,adjustX:0,adjustY:0}})(jQuery);
